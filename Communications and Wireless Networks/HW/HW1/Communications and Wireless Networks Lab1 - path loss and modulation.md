# 1. Results for d=[50:50:600]

## 1.1. P_rx derived from the path loss model

| Distance (m) | P_rx (W) | P_rx (dBm) |
| --- | --- | --- |
| 50 | 3.957859e-10 | -64.025397 |
| 100 | 9.894647e-11 | -70.045997 |
| 150 | 4.397621e-11 | -73.567822 |
| 200 | 2.473662e-11 | -76.066597 |
| 250 | 1.583143e-11 | -78.004797 |
| 300 | 1.099405e-11 | -79.588422 |
| 350 | 8.077263e-12 | -80.927358 |
| 400 | 6.184154e-12 | -82.087197 |
| 450 | 4.886245e-12 | -83.110247 |
| 500 | 3.957859e-12 | -84.025397 |
| 550 | 3.270958e-12 | -84.853251 |
| 600 | 2.748513e-12 | -85.609022 |

## 1.2. Empirical and theoretical average noise power

| Distance (m) | Empirical Noise Power BPSK (W) | Empirical Noise Power QPSK (W) | Empirical Noise Power QAM16 (W) | Empirical Noise Power QAM64 (W) |
| --- | --- | --- | --- | --- |
| 50 | 2.524614e-03 | 2.519776e-03 | 2.519485e-03 | 2.515800e-03 |
| 100 | 1.009845e-02 | 1.007910e-02 | 1.007794e-02 | 1.006320e-02 |
| 150 | 2.272152e-02 | 2.267798e-02 | 2.267536e-02 | 2.264220e-02 |
| 200 | 4.039382e-02 | 4.031641e-02 | 4.031176e-02 | 4.025279e-02 |
| 250 | 6.311534e-02 | 6.299440e-02 | 6.298712e-02 | 6.289499e-02 |
| 300 | 9.088609e-02 | 9.071193e-02 | 9.070146e-02 | 9.056878e-02 |
| 350 | 1.237061e-01 | 1.234690e-01 | 1.234548e-01 | 1.232742e-01 |
| 400 | 1.615753e-01 | 1.612657e-01 | 1.612470e-01 | 1.610112e-01 |
| 450 | 2.044937e-01 | 2.041018e-01 | 2.040783e-01 | 2.037798e-01 |
| 500 | 2.524614e-01 | 2.519776e-01 | 2.519485e-01 | 2.515800e-01 |
| 550 | 3.054782e-01 | 3.048929e-01 | 3.048577e-01 | 3.044117e-01 |
| 600 | 3.635443e-01 | 3.628477e-01 | 3.628058e-01 | 3.622751e-01 |

| Distance (m) | Empirical Noise Power BPSK (dBm) | Empirical Noise Power QPSK (dBm) | Empirical Noise Power QAM16 (dBm) | Empirical Noise Power QAM64 (dBm) |
| --- | --- | --- | --- | --- |
| 50 | 4.021949 | 4.013619 | 4.013118 | 4.006760 |
| 100 | 10.042549 | 10.034219 | 10.033718 | 10.027360 |
| 150 | 13.564374 | 13.556044 | 13.555543 | 13.549185 |
| 200 | 16.063149 | 16.054819 | 16.054317 | 16.047960 |
| 250 | 18.001349 | 17.993019 | 17.992518 | 17.986160 |
| 300 | 19.584974 | 19.576644 | 19.576143 | 19.569785 |
| 350 | 20.923910 | 20.915580 | 20.915078 | 20.908721 |
| 400 | 22.083749 | 22.075419 | 22.074917 | 22.068560 |
| 450 | 23.106799 | 23.098469 | 23.097968 | 23.091610 |
| 500 | 24.021949 | 24.013619 | 24.013118 | 24.006760 |
| 550 | 24.849803 | 24.841473 | 24.840971 | 24.834614 |
| 600 | 25.605574 | 25.597244 | 25.596743 | 25.590385 |

The theoretical noise power is 1.000000e-12 W (-90.000000 dBm).

## 1.3. SNR and SNR_dB

| Distance (m) | SNR BPSK   | SNR QPSK   | SNR QAM16  | SNR QAM64  |
| ------------ | ---------- | ---------- | ---------- | ---------- |
| 50           | 396.100230 | 396.860690 | 396.572066 | 397.039737 |
| 100          | 99.025057  | 99.215173  | 99.143016  | 99.259934  |
| 150          | 44.011137  | 44.095632  | 44.063563  | 44.115526  |
| 200          | 24.756264  | 24.803793  | 24.785754  | 24.814984  |
| 250          | 15.844009  | 15.874428  | 15.862883  | 15.881589  |
| 300          | 11.002784  | 11.023908  | 11.015891  | 11.028882  |
| 350          | 8.083678   | 8.099198   | 8.093307   | 8.102852   |
| 400          | 6.189066   | 6.200948   | 6.196439   | 6.203746   |
| 450          | 4.890126   | 4.899515   | 4.895951   | 4.901725   |
| 500          | 3.961002   | 3.968607   | 3.965721   | 3.970397   |
| 550          | 3.273556   | 3.279840   | 3.277455   | 3.281320   |
| 600          | 2.750696   | 2.755977   | 2.753973   | 2.757220   |

| Distance (m) | SNR BPSK (dB) | SNR QPSK (dB) | SNR QAM16 (dB) | SNR QAM64 (dB) |
| ------------ | ------------- | ------------- | -------------- | -------------- |
| 50           | 25.978051     | 25.986381     | 25.983221      | 25.988340      |
| 100          | 19.957451     | 19.965781     | 19.962621      | 19.967740      |
| 150          | 16.435626     | 16.443956     | 16.440796      | 16.445915      |
| 200          | 13.936851     | 13.945181     | 13.942021      | 13.947140      |
| 250          | 11.998651     | 12.006981     | 12.003821      | 12.008940      |
| 300          | 10.415026     | 10.423356     | 10.420196      | 10.425315      |
| 350          | 9.076090      | 9.084420      | 9.081260       | 9.086379       |
| 400          | 7.916251      | 7.924581      | 7.921421       | 7.926540       |
| 450          | 6.893201      | 6.901531      | 6.898371       | 6.903490       |
| 500          | 5.978051      | 5.986381      | 5.983221       | 5.988340       |
| 550          | 5.150197      | 5.158527      | 5.155367       | 5.160486       |
| 600          | 4.394426      | 4.402756      | 4.399596       | 4.404715       |

## 1.4. Empirical BER

| Distance (m) | Empirical BER BPSK | Empirical BER QPSK | Empirical BER QAM16 | Empirical BER QAM64 |
| ------------ | ------------------ | ------------------ | ------------------- | ------------------- |
| 50           | 0.000000e+00       | 0.000000e+00       | 0.000000e+00        | 1.000000e-05        |
| 100          | 0.000000e+00       | 0.000000e+00       | 3.333333e-06        | 1.344333e-02        |
| 150          | 0.000000e+00       | 0.000000e+00       | 1.396667e-03        | 6.754000e-02        |
| 200          | 0.000000e+00       | 0.000000e+00       | 1.288667e-02        | 1.269833e-01        |
| 250          | 0.000000e+00       | 2.666667e-05       | 3.736333e-02        | 1.753567e-01        |
| 300          | 3.333333e-06       | 5.233333e-04       | 6.851667e-02        | 2.106833e-01        |
| 350          | 4.333333e-05       | 2.260000e-03       | 1.006367e-01        | 2.403667e-01        |
| 400          | 2.700000e-04       | 6.596667e-03       | 1.324333e-01        | 2.602533e-01        |
| 450          | 8.933333e-04       | 1.362667e-02       | 1.596600e-01        | 2.791367e-01        |
| 500          | 2.503333e-03       | 2.264667e-02       | 1.852367e-01        | 2.914067e-01        |
| 550          | 5.403333e-03       | 3.451000e-02       | 2.063067e-01        | 3.040667e-01        |
| 600          | 9.776667e-03       | 4.892667e-02       | 2.260267e-01        | 3.154767e-01        |

## 1.5. Empirical and theoretical throughput

| Distance (m) | Empirical Throughput BPSK (bps) | Empirical Throughput QPSK (bps) | Empirical Throughput QAM16 (bps) | Empirical Throughput QAM64 (bps) |
| --- | --- | --- | --- | --- |
| 50 | 3.125000e+05 | 6.250000e+05 | 1.250000e+06 | 1.800000e+06 |
| 100 | 3.125000e+05 | 6.250000e+05 | 1.233333e+06 | 0.000000e+00 |
| 150 | 3.125000e+05 | 6.250000e+05 | 0.000000e+00 | 0.000000e+00 |
| 200 | 3.125000e+05 | 6.250000e+05 | 0.000000e+00 | 0.000000e+00 |
| 250 | 3.125000e+05 | 5.583333e+05 | 0.000000e+00 | 0.000000e+00 |
| 300 | 3.083333e+05 | 5.833333e+04 | 0.000000e+00 | 0.000000e+00 |
| 350 | 2.583333e+05 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |
| 400 | 9.583333e+04 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |
| 450 | 1.666667e+04 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |
| 500 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |
| 550 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |
| 600 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 | 0.000000e+00 |

| Distance (m) | Theoretical Throughput BPSK (bps) | Theoretical Throughput QPSK (bps) | Theoretical Throughput QAM16 (bps) | Theoretical Throughput QAM64 (bps) |
| --- | --- | --- | --- | --- |
| 50 | 3.125000e+05 | 6.250000e+05 | 1.250000e+06 | 1.801480e+06 |
| 100 | 3.125000e+05 | 6.250000e+05 | 1.233444e+06 | 5.769577e-18 |
| 150 | 3.125000e+05 | 6.250000e+05 | 4.666117e+03 | 6.220776e-116 |
| 200 | 3.125000e+05 | 6.250000e+05 | 3.672676e-17 | 2.307495e-230 |
| 250 | 3.125000e+05 | 5.617650e+05 | 8.841164e-61 | 0.000000e+00 |
| 300 | 3.083610e+05 | 7.700500e+04 | 6.269957e-118 | 0.000000e+00 |
| 350 | 2.627669e+05 | 7.335248e+01 | 6.880506e-179 | 0.000000e+00 |
| 400 | 1.061081e+05 | 1.987612e-06 | 2.033946e-241 | 0.000000e+00 |
| 450 | 8.755430e+03 | 9.144717e-19 | 8.261434e-297 | 0.000000e+00 |
| 500 | 1.382491e+01 | 1.005250e-34 | 0.000000e+00 | 0.000000e+00 |
| 550 | 1.210173e-04 | 6.123502e-56 | 0.000000e+00 | 0.000000e+00 |
| 600 | 2.675918e-12 | 4.486416e-82 | 0.000000e+00 | 0.000000e+00 |

## 1.6. The optimal modulation scheme for link distance

| Distance (m) | Optimal Modulation Scheme |
| ------------ | ------------------------- |
| 50           | QAM64                     |
| 100          | QAM16                     |
| 150          | QPSK                      |
| 200          | QPSK                      |
| 250          | QPSK                      |
| 300          | BPSK                      |
| 350          | BPSK                      |
| 400          | BPSK                      |
| 450          | BPSK                      |
| 500          | BPSK                      |
| 550          | BPSK                      |
| 600          | BPSK                      |

## 1.7. Figures

![[BPSK_Constellation_with_40m.png]]

![[QPSK_Constellation_with_20m.png]]

![[QAM16_Constellation_with_10m.png]]

![[QAM64_Constellation_with_5m.png]]

![[throughput_vs_distance.png]]

# 2. Questions

## 2.1. The theoretical optimal modulation with a theoretical modulation table

Using the script below:

```matlab
function [P_rx_W, P_rx_dBm] = ...
    calculate_received_power(d)
    % Constants
    c = 3e8; % Speed of light (m/s)

    % Tx Parameters
    f = 2.4e9; % Frequency (Hz)
    P_tx_dBm = 10; % Transmit power (dBm)
    P_tx = 10^(P_tx_dBm / 10) * 1e-3; % Transmit power (W)
    G_tx = 1; % Transmit antenna gain

    % Rx Parameters
    G_rx = 1; % Receive antenna gain

    % Calculate the wavelength
    lambda = c / f;

    % Received Power (dBm)
    P_rx_dBm = P_tx_dBm + 10 * log10(G_tx) + ...
        10 * log10(G_rx) + ...
        20 * log10(lambda / (4 * pi * d));

    % Convert dBm to Watts
    P_rx_W = 10^(P_rx_dBm / 10) * 1e-3;
end

function [best_scheme] = best_modulation_scheme(d, l)
    % d: distance in meters
    % l: packet length in bits
    % best_scheme: best modulation scheme

    load('SNR_BER.mat');

    [P_rx_W, P_rx_dBm] = calculate_received_power(d);
    noise_power_dBm = -90;
    noise_power_W = 10^(noise_power_dBm/10) * 1e-3;
    SNR = P_rx_W / noise_power_W;
    
    if SNR > 31
        BER = [0; 0; 0; 0];
    else
        SNR_floor = floor(SNR);
        delta = SNR - SNR_floor;
        BER = SNR_BER(:, SNR_floor) * (1 - delta) + SNR_BER(:, SNR_floor + 1) * delta;
    end

    PDR = (1 - BER) .^ l;

    sample_duration_s = 3.2e-6;
    throughput = [1; 2; 4; 6] .* PDR / sample_duration_s;
    [best_throughput, best_scheme_index] = max(throughput);
    modulation_schemes = ["BPSK", "QPSK", "16-QAM", "64-QAM"];
    best_scheme = modulation_schemes(best_scheme_index);
end

fprintf('| Distance (m) / Packet Length (bits) | 500 | 1000 | 2000 | 4000 | 8000 |\n');
fprintf('| --- | --- | --- | --- | --- | --- |\n');
for d = 50:50:600
    fprintf('| %d |', d);
    for l = [500, 1000, 2000, 4000, 8000]
        best_scheme = best_modulation_scheme(d, l);
        fprintf(' %s |', best_scheme);
    end
    fprintf('\n');
end
```

We can get the theoretical best modulation scheme table:

| Distance (m) / Packet Length (bits) | 500    | 1000   | 2000   | 4000   | 8000   |
| ----------------------------------- | ------ | ------ | ------ | ------ | ------ |
| 50                                  | 64-QAM | 64-QAM | 64-QAM | 64-QAM | 64-QAM |
| 100                                 | 64-QAM | 64-QAM | 64-QAM | 64-QAM | 64-QAM |
| 150                                 | 64-QAM | 64-QAM | 64-QAM | 64-QAM | 64-QAM |
| 200                                 | QPSK   | QPSK   | QPSK   | QPSK   | QPSK   |
| 250                                 | QPSK   | QPSK   | QPSK   | QPSK   | QPSK   |
| 300                                 | QPSK   | QPSK   | QPSK   | QPSK   | QPSK   |
| 350                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |
| 400                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |
| 450                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |
| 500                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |
| 550                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |
| 600                                 | BPSK   | BPSK   | BPSK   | BPSK   | BPSK   |

The empirical rate seems to have worse noise than the theoretical result. We can see that the theoretical best modulation switched to QPSK when the distance comes to 200m, but empirical test suggest that we should switch to QPSK when the distance is 150m.

This is due to the noise being amplified in the demodulation process, where the symbols $y$ is divided by channel $h$. In the theoretical table, we did not consider the effect of channel $h$.

## 2.2. What I have learned

I wasn't used to programming in matlab before this lab. This lab helps me to get familiar with the syntax of matlab, and also give me a comprehensive view of what happened during signal transmission.

## 2.3. Difficulty in this lab

Because I was not familiar with matlab code and the calculations were complicated, I spent much time debugging and experimenting different syntax. For example, I named a file with hyphen `-` and matlab gave me an error.